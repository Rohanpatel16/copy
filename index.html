<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Resume Analyzer with Chat</title>
    
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- Google Generative AI SDK -->
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        /* API Key Setup */
        .api-key-section {
            background: #f0f8ff;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .api-key-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .api-key-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .api-key-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .api-key-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .api-key-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #999;
            font-size: 14px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .options {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .option label {
            cursor: pointer;
            color: #555;
        }
        
        .progress-container {
            display: none;
            margin-bottom: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 15px;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .status-message {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .results-container {
            display: none;
        }
        
        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .text-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        
        .chat-section {
            background: #f0f8ff;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }
        
        .section-title {
            font-size: 1.2em;
            color: #333;
            font-weight: 600;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .text-output {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        /* Chat Interface Styles */
        .chat-messages {
            flex: 1;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }
        
        .message.user {
            text-align: right;
        }
        
        .message.ai {
            text-align: left;
        }
        
        .message-content {
            display: inline-block;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .message.ai .message-content {
            background: #f0f0f0;
            color: #333;
        }
        
        .message-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .send-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .suggestion-chip {
            padding: 6px 12px;
            background: white;
            border: 1px solid #667eea;
            border-radius: 20px;
            color: #667eea;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .suggestion-chip:hover {
            background: #667eea;
            color: white;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            width: fit-content;
            margin-bottom: 10px;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .stats {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .error-message {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        @media (max-width: 768px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
        }
        
        /* Markdown Styles */
        .message-content h1, .message-content h2, .message-content h3 {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        .message-content ul, .message-content ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .message-content code {
            background: #f4f4f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Consolas', 'Courier New', monospace;
        }
        
        .message-content pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        
        .message-content blockquote {
            border-left: 3px solid #667eea;
            padding-left: 10px;
            margin: 10px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🤖 AI-Powered Resume Analyzer</h1>
        <p class="subtitle">Extract text from CVs and chat with AI about the content</p>
        
        <!-- API Key Section -->
        <div class="api-key-section">
            <div style="display: flex; align-items: center;">
                <strong>🔑 Google Gemini API Setup</strong>
                <span class="api-key-status disconnected" id="apiStatus">Not Connected</span>
            </div>
            <p style="font-size: 14px; color: #666; margin-top: 5px;">
                Get your free API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
            </p>
            <div class="api-key-input-group">
                <input type="password" class="api-key-input" id="apiKeyInput" placeholder="Enter your Gemini API key...">
                <button class="btn btn-success" onclick="saveApiKey()">Connect</button>
            </div>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">📤</div>
            <div class="upload-text">Click to upload or drag & drop your CV/Resume PDF</div>
            <div class="upload-hint">Supports both text-based and scanned PDFs</div>
            <input type="file" id="fileInput" accept=".pdf">
        </div>
        
        <div class="options">
            <div class="option">
                <input type="checkbox" id="enableOCR" checked>
                <label for="enableOCR">Enable OCR for images</label>
            </div>
            <div class="option">
                <input type="checkbox" id="fixSpacing" checked>
                <label for="fixSpacing">Fix character spacing issues</label>
            </div>
            <div class="option">
                <input type="checkbox" id="smartFormat" checked>
                <label for="smartFormat">Smart formatting</label>
            </div>
            <div class="option">
                <input type="checkbox" id="enhanceImages">
                <label for="enhanceImages">Enhance image quality</label>
            </div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="status-message" id="statusMessage">Initializing...</div>
        </div>
        
        <div class="results-container" id="resultsContainer">
            <div class="content-wrapper">
                <!-- Text Output Section -->
                <div class="text-section">
                    <div class="section-header">
                        <div class="section-title">📄 Extracted Resume</div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="copyText()">📋 Copy</button>
                            <button class="btn btn-secondary" onclick="downloadText()">💾 Download</button>
                            <button class="btn btn-primary" onclick="resetUpload()">📄 New PDF</button>
                        </div>
                    </div>
                    <div class="text-output" id="textOutput"></div>
                </div>
                
                <!-- Chat Section -->
                <div class="chat-section">
                    <div class="section-header">
                        <div class="section-title">💬 AI Resume Assistant</div>
                        <button class="btn btn-secondary" onclick="clearChat()">🗑️ Clear Chat</button>
                    </div>
                    
                    <div class="suggested-questions" id="suggestedQuestions">
                        <div class="suggestion-chip" onclick="askQuestion(this.textContent)">Summarize this resume</div>
                        <div class="suggestion-chip" onclick="askQuestion(this.textContent)">What are the key skills?</div>
                        <div class="suggestion-chip" onclick="askQuestion(this.textContent)">Years of experience?</div>
                        <div class="suggestion-chip" onclick="askQuestion(this.textContent)">Is this person suitable for a senior role?</div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai">
                            <div class="message-label">AI Assistant</div>
                            <div class="message-content">
                                Hello! I've analyzed the resume. Feel free to ask me anything about the candidate's qualifications, experience, skills, or suitability for specific roles.
                            </div>
                        </div>
                    </div>
                    
                    <div class="typing-indicator" id="typingIndicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    
                    <div class="chat-input-container">
                        <textarea class="chat-input" id="chatInput" placeholder="Ask about the resume..." rows="2"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="pageCount">0</div>
                    <div class="stat-label">Pages</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="wordCount">0</div>
                    <div class="stat-label">Words</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="charCount">0</div>
                    <div class="stat-label">Characters</div>
                </div>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
    </div>
    
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        
        // Global variables
        let genAI = null;
        let model = null;
        let chat = null;
        let apiKey = '';
        let extractedText = '';
        let cleanedText = '';
        let formattedText = '';
        let currentFileName = '';
        let currentView = 'cleaned';
        
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Check for saved API key on load
        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
                window.saveApiKey();
            }
        });
        
        // Save API Key
        window.saveApiKey = function() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showError('Please enter a valid API key');
                return;
            }
            
            try {
                // Initialize Gemini AI
                genAI = new GoogleGenerativeAI(apiKey);
                model = genAI.getGenerativeModel({ model: "gemini-pro" });
                
                // Save to localStorage
                localStorage.setItem('gemini_api_key', apiKey);
                
                // Update UI
                document.getElementById('apiStatus').textContent = 'Connected';
                document.getElementById('apiStatus').className = 'api-key-status connected';
                showToast('Successfully connected to Gemini AI!');
            } catch (error) {
                showError('Failed to initialize Gemini AI: ' + error.message);
            }
        }
        
        // Upload area setup
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const statusMessage = document.getElementById('statusMessage');
        const resultsContainer = document.getElementById('resultsContainer');
        const textOutput = document.getElementById('textOutput');
        const errorMessage = document.getElementById('errorMessage');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        
        // Click to upload
        uploadArea.addEventListener('click', () => fileInput.click());
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFile(files[0]);
            } else {
                showError('Please upload a valid PDF file');
            }
        });
        
        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        // Enter key to send message
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                window.sendMessage();
            }
        });
        
        // Handle file processing
        async function handleFile(file) {
            if (file.type !== 'application/pdf') {
                showError('Please upload a valid PDF file');
                return;
            }
            
            currentFileName = file.name;
            extractedText = '';
            cleanedText = '';
            formattedText = '';
            hideError();
            showProgress();
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                await extractTextFromPDF(arrayBuffer);
            } catch (error) {
                showError('Error processing PDF: ' + error.message);
                hideProgress();
            }
        }
        
        // Extract text from PDF
        async function extractTextFromPDF(arrayBuffer) {
            updateStatus('Loading PDF document...');
            
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const totalPages = pdf.numPages;
            let fullText = '';
            
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                updateProgress((pageNum - 1) / totalPages * 100, `Processing page ${pageNum} of ${totalPages}...`);
                
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                let pageText = '';
                
                if (textContent.items && textContent.items.length > 0) {
                    const sortedItems = textContent.items.sort((a, b) => {
                        const yDiff = b.transform[5] - a.transform[5];
                        if (Math.abs(yDiff) > 5) return yDiff;
                        return a.transform[4] - b.transform[4];
                    });
                    
                    let lastY = null;
                    let lineText = '';
                    
                    sortedItems.forEach((item, index) => {
                        const currentY = item.transform[5];
                        const text = item.str;
                        
                        if (lastY !== null && Math.abs(currentY - lastY) > 5) {
                            if (lineText.trim()) {
                                pageText += lineText + '\n';
                            }
                            lineText = text;
                        } else {
                            if (lineText && !lineText.endsWith(' ') && !text.startsWith(' ')) {
                                lineText += ' ';
                            }
                            lineText += text;
                        }
                        
                        lastY = currentY;
                        
                        if (index === sortedItems.length - 1 && lineText.trim()) {
                            pageText += lineText + '\n';
                        }
                    });
                } else if (document.getElementById('enableOCR').checked) {
                    updateStatus(`Running OCR on page ${pageNum}...`);
                    pageText = await performOCR(page);
                }
                
                if (pageText.trim()) {
                    fullText += pageText + '\n';
                }
            }
            
            extractedText = fullText.trim() || 'No text could be extracted from this PDF.';
            
            // Apply text cleaning and formatting
            if (document.getElementById('fixSpacing').checked) {
                cleanedText = fixCharacterSpacing(extractedText);
            } else {
                cleanedText = extractedText;
            }
            
            if (document.getElementById('smartFormat').checked) {
                formattedText = smartFormatText(cleanedText);
            } else {
                formattedText = cleanedText;
            }
            
            // Initialize AI chat with resume context
            if (model) {
                await initializeChat();
            }
            
            displayResults();
        }
        
        // Initialize chat with resume context
        async function initializeChat() {
            const context = `You are an AI resume analyst. I've just uploaded a resume/CV with the following content:
            
            ${cleanedText}
            
            You should help analyze this resume by:
            - Providing summaries and insights
            - Identifying key skills and experiences
            - Assessing suitability for different roles
            - Highlighting strengths and potential areas for improvement
            - Answering specific questions about the candidate
            
            Be professional, objective, and helpful in your analysis.`;
            
            chat = model.startChat({
                history: [
                    {
                        role: "user",
                        parts: context
                    },
                    {
                        role: "model",
                        parts: "I've analyzed the resume. I can help you understand the candidate's qualifications, experience, skills, and suitability for various roles. What would you like to know?"
                    }
                ],
                generationConfig: {
                    maxOutputTokens: 1000,
                    temperature: 0.7,
                },
            });
        }
        
        // Send message to AI
        window.sendMessage = async function() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            if (!model) {
                showError('Please set up your Gemini API key first');
                return;
            }
            
            // Add user message to chat
            addMessage(message, 'user');
            chatInput.value = '';
            sendBtn.disabled = true;
            
            // Show typing indicator
            typingIndicator.style.display = 'block';
            
            try {
                // Send message to Gemini
                const result = await chat.sendMessage(message);
                const response = await result.response;
                const text = response.text();
                
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                
                // Add AI response
                addMessage(text, 'ai');
            } catch (error) {
                typingIndicator.style.display = 'none';
                showError('Failed to get AI response: ' + error.message);
                addMessage('Sorry, I encountered an error. Please try again.', 'ai');
            } finally {
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }
        
        // Ask a suggested question
        window.askQuestion = function(question) {
            chatInput.value = question;
            window.sendMessage();
        }
        
        // Add message to chat
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'message-label';
            labelDiv.textContent = sender === 'user' ? 'You' : 'AI Assistant';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Convert markdown to HTML for AI messages
            if (sender === 'ai') {
                contentDiv.innerHTML = marked.parse(text);
            } else {
                contentDiv.textContent = text;
            }
            
            messageDiv.appendChild(labelDiv);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Clear chat
        window.clearChat = function() {
            chatMessages.innerHTML = `
                <div class="message ai">
                    <div class="message-label">AI Assistant</div>
                    <div class="message-content">
                        Chat cleared. Feel free to ask me anything about the resume!
                    </div>
                </div>
            `;
            if (model && cleanedText) {
                initializeChat();
            }
        }
        
        // Fix character spacing issues
        function fixCharacterSpacing(text) {
            let fixed = text.replace(/(\b\w)\s+(?=\w\b)/g, '$1');
            fixed = fixed.replace(/([A-Z])\s+([A-Z])\s+([A-Z])/g, '$1$2$3');
            fixed = fixed.replace(/(\d)\s+(\d)/g, '$1$2');
            
            const patterns = [
                /C\s+O\s+N\s+T\s+A\s+C\s+T/g,
                /P\s+R\s+O\s+F\s+I\s+L\s+E/g,
                /E\s+X\s+P\s+E\s+R\s+I\s+E\s+N\s+C\s+E/g,
                /E\s+D\s+U\s+C\s+A\s+T\s+I\s+O\s+N/g,
                /S\s+K\s+I\s+L\s+L\s+S/g,
            ];
            
            const replacements = [
                'CONTACT',
                'PROFILE',
                'EXPERIENCE',
                'EDUCATION',
                'SKILLS'
            ];
            
            patterns.forEach((pattern, index) => {
                fixed = fixed.replace(pattern, replacements[index]);
            });
            
            fixed = fixed.replace(/\s{2,}/g, ' ');
            fixed = fixed.replace(/\s+([.,;:!?])/g, '$1');
            fixed = fixed.replace(/([.,;:!?])(?!\s|$|\n)/g, '$1 ');
            
            return fixed;
        }
        
        // Smart format text
        function smartFormatText(text) {
            let formatted = text;
            formatted = formatted.replace(/\.(?=[A-Z])/g, '. ');
            formatted = formatted.replace(/(CONTACT|PROFILE|EXPERIENCE|EDUCATION|SKILLS|SUMMARY)/g, '\n\n=== $1 ===\n');
            formatted = formatted.replace(/^[\s]*[-•·]\s*/gm, '\n• ');
            formatted = formatted.replace(/\n{3,}/g, '\n\n');
            return formatted.trim();
        }
        
        // Perform OCR on page
        async function performOCR(page) {
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;
            
            if (document.getElementById('enhanceImages').checked) {
                enhanceImage(context, canvas.width, canvas.height);
            }
            
            const result = await Tesseract.recognize(canvas, 'eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const progress = m.progress * 100;
                        updateStatus(`OCR Progress: ${progress.toFixed(0)}%`);
                    }
                }
            });
            
            return result.data.text;
        }
        
        // Enhance image for better OCR
        function enhanceImage(context, width, height) {
            const imageData = context.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                const enhanced = gray > 128 ? 255 : 0;
                data[i] = enhanced;
                data[i + 1] = enhanced;
                data[i + 2] = enhanced;
            }
            
            context.putImageData(imageData, 0, 0);
        }
        
        // Display results
        function displayResults() {
            hideProgress();
            resultsContainer.style.display = 'block';
            textOutput.textContent = cleanedText || extractedText;
            
            const textForStats = cleanedText || extractedText;
            const words = textForStats.split(/\s+/).filter(word => word.length > 0);
            const pages = (textForStats.match(/--- Page \d+ ---/g) || []).length;
            
            document.getElementById('pageCount').textContent = pages || 1;
            document.getElementById('wordCount').textContent = words.length;
            document.getElementById('charCount').textContent = textForStats.length;
        }
        
        // Copy text to clipboard
        window.copyText = async function() {
            const textToCopy = cleanedText || extractedText;
            try {
                await navigator.clipboard.writeText(textToCopy);
                showToast('Text copied to clipboard!');
            } catch (err) {
                showError('Failed to copy text');
            }
        }
        
        // Download text as file
        window.downloadText = function() {
            const textToDownload = cleanedText || extractedText;
            const blob = new Blob([textToDownload], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName.replace('.pdf', '_extracted.txt');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showToast('Text file downloaded!');
        }
        
        // Reset for new upload
        window.resetUpload = function() {
            fileInput.value = '';
            extractedText = '';
            cleanedText = '';
            formattedText = '';
            currentFileName = '';
            resultsContainer.style.display = 'none';
            uploadArea.style.display = 'block';
            clearChat();
        }
        
        // Helper functions
        function showProgress() {
            uploadArea.style.display = 'none';
            progressContainer.style.display = 'block';
            resultsContainer.style.display = 'none';
        }
        
        function hideProgress() {
            progressContainer.style.display = 'none';
        }
        
        function updateProgress(percent, message) {
            progressFill.style.width = percent + '%';
            progressFill.textContent = Math.round(percent) + '%';
            if (message) {
                statusMessage.textContent = message;
            }
        }
        
        function updateStatus(message) {
            statusMessage.textContent = message;
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
        
        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
