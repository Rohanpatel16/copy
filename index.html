<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruiter's AI Assistant - Powered by Gemini</title>
    
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Google AI SDK -->
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    
    <style>
        :root {
            --primary-color: #4a69bd;
            --secondary-color: #1abc9c;
            --dark-color: #2c3e50;
            --light-bg: #f8f9ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
            padding: 40px;
        }
        
        h1 { color: var(--dark-color); margin-bottom: 10px; font-size: 2em; text-align: center; }
        
        .subtitle { text-align: center; color: #555; margin-bottom: 30px; }
        
        .api-key-container {
            background: var(--light-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .api-key-container input {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-right: 10px;
        }
        .api-key-container button {
             padding: 12px 20px;
             font-weight: 600;
        }

        .upload-area {
            border: 3px dashed var(--secondary-color);
            border-radius: 15px; padding: 40px; text-align: center;
            background: #f8f9ff; transition: all 0.3s ease; cursor: pointer; margin-bottom: 30px;
        }
        .upload-area:hover { border-color: var(--primary-color); background: #f0f2ff; }
        .upload-icon { font-size: 48px; color: var(--secondary-color); margin-bottom: 15px; }
        input[type="file"] { display: none; }
        
        .progress-container { display: none; margin-bottom: 30px; }
        .progress-bar { width: 100%; height: 30px; background: #f0f0f0; border-radius: 15px; overflow: hidden; }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            border-radius: 15px; width: 0%; transition: width 0.3s ease;
            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;
        }
        .status-message { text-align: center; margin-top: 10px; color: #666; font-size: 14px; }
        
        .results-container { display: none; }
        .main-layout { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .ai-actions-panel { background: var(--light-bg); border-radius: 15px; padding: 20px; }
        .ai-actions-title { font-size: 1.2em; color: var(--dark-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .action-button {
            display: block; width: 100%; padding: 15px; margin-bottom: 10px; border: none;
            border-radius: 8px; background: #fff; color: #333; font-size: 15px; font-weight: 600;
            text-align: left; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .action-button:hover, .action-button.loading { background: var(--secondary-color); color: white; transform: translateX(5px); }
        .action-button.loading { cursor: not-allowed; animation: pulse 1.5s infinite; }

        .output-panel { min-height: 400px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .results-title { font-size: 1.5em; color: #333; }
        
        .btn { padding: 8px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(74, 105, 189, 0.4); }
        .btn-secondary { background: #f0f0f0; color: #666; }
        .btn-secondary.active { background: var(--dark-color); color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        
        .text-output {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px; padding: 20px;
            height: 500px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;
            font-size: 14px; line-height: 1.7;
        }
        .ai-insights { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; }
        .ai-insights h3 { color: var(--dark-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px; margin-top: 20px; margin-bottom: 10px; }
        .ai-insights ul { list-style-position: inside; padding-left: 10px; }
        .ai-insights strong { color: var(--primary-color); }
        .bottom-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        
        .info-box { background: #e7f3ff; border-left: 4px solid #3498db; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .info-box p { color: #555; font-size: 14px; margin: 5px 0; }
        .info-box a { color: var(--primary-color); font-weight: bold; }
        .error-message { background: #fee; color: #c00; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Recruiter's AI Assistant</h1>
        <p class="subtitle">Analyze resumes with the power of Google's Gemini AI</p>

        <div id="apiKeyContainer" class="api-key-container">
            <h3>Enter Your Google AI API Key</h3>
            <p style="font-size: 14px; color: #666; margin: 10px 0;">Your key is stored only in your browser and is never shared.</p>
            <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API Key">
            <button class="btn btn-primary" id="saveApiKeyBtn">Save Key</button>
            <p style="font-size: 12px; margin-top: 15px;">
                <a href="https://aistudio.google.com/app/apikey" target="_blank">Get your API key from Google AI Studio</a>
            </p>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="info-box">
                <p>üöÄ <strong>Powered by Gemini:</strong> All insights are generated by Google's AI. Your API key is active.</p>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Click to upload or drag & drop a resume (PDF)</div>
                <input type="file" id="fileInput" accept=".pdf">
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div>
                <div class="status-message" id="statusMessage">Initializing...</div>
            </div>
        </div>

        <div class="results-container" id="resultsContainer">
            <div class="main-layout">
                <div class="ai-actions-panel">
                    <h3 class="ai-actions-title">AI Analysis Actions</h3>
                    <button class="action-button" id="btn-redFlags" onclick="runAIAnalysis('redFlags')">üîç Screen for Issues & Red Flags</button>
                    <button class="action-button" id="btn-summary" onclick="runAIAnalysis('summary')">üìù Generate Candidate Summary</button>
                    <button class="action-button" id="btn-questions" onclick="runAIAnalysis('questions')">‚ùì Generate Interview Questions</button>
                    <button class="action-button" id="btn-email" onclick="runAIAnalysis('email')">üìß Draft Outreach Email</button>
                </div>
                <div class="output-panel">
                    <div class="results-header">
                        <div class="results-title" id="resultsTitle">AI Insights</div>
                        <div>
                            <button class="btn btn-secondary active" id="aiViewBtn" onclick="showAIView()">AI Insights</button>
                            <button class="btn btn-secondary" id="textViewBtn" onclick="showTextView()">Raw Text</button>
                        </div>
                    </div>
                    <div class="text-output" id="textOutput"></div>
                     <div class="bottom-actions">
                        <button class="btn btn-secondary" onclick="copyText()">üìã Copy Insights</button>
                        <button class="btn btn-primary" onclick="resetUpload()">+ Upload New Resume</button>
                        <button class="btn btn-danger" id="resetApiKeyBtn">Reset API Key</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
    </div>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let extractedText = '';
        let aiInsightsCache = {};
        let currentView = 'ai';
        let genAI, aiModel;

        const apiKeyContainer = document.getElementById('apiKeyContainer');
        const mainContent = document.getElementById('mainContent');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const resetApiKeyBtn = document.getElementById('resetApiKeyBtn');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const statusMessage = document.getElementById('statusMessage');
        const resultsContainer = document.getElementById('resultsContainer');
        const textOutput = document.getElementById('textOutput');
        const errorMessage = document.getElementById('errorMessage');
        const resultsTitle = document.getElementById('resultsTitle');
        const aiViewBtn = document.getElementById('aiViewBtn');
        const textViewBtn = document.getElementById('textViewBtn');

        document.addEventListener('DOMContentLoaded', () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (apiKey) {
                initializeAI(apiKey);
            } else {
                apiKeyContainer.style.display = 'block';
                mainContent.style.display = 'none';
            }
        });

        saveApiKeyBtn.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                initializeAI(apiKey);
            } else {
                showError("Please enter a valid API key.");
            }
        });

        resetApiKeyBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to reset your API key?")) {
                localStorage.removeItem('geminiApiKey');
                location.reload();
            }
        });

        function initializeAI(apiKey) {
            try {
                genAI = new window.GoogleGenerativeAI(apiKey);
                aiModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash-lite" });
                apiKeyContainer.style.display = 'none';
                mainContent.style.display = 'block';
                hideError();
            } catch (error) {
                showError("Failed to initialize AI. The API key might be invalid.");
                localStorage.removeItem('geminiApiKey');
            }
        }

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        
        async function handleFile(file) {
            if (file.type !== 'application/pdf') {
                showError('Please upload a valid PDF file');
                return;
            }
            hideError();
            showProgress();
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                extractedText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    updateProgress((i - 1) / pdf.numPages * 100, `Extracting text from page ${i}...`);
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    extractedText += textContent.items.map(item => item.str).join(' ');
                }
                displayResults();
            } catch (error) {
                showError('Error processing PDF: ' + error.message);
                hideProgress();
            }
        }
        
        function displayResults() {
            hideProgress();
            resultsContainer.style.display = 'block';
            aiInsightsCache = {}; // Clear cache for new resume
            runAIAnalysis('summary');
        }

        async function runAIAnalysis(type) {
            if (!aiModel) {
                showError("AI is not initialized. Please check your API Key.");
                return;
            }

            // Check cache first
            if (aiInsightsCache[type]) {
                textOutput.innerHTML = aiInsightsCache[type];
                updateTitlesAndViews(type);
                return;
            }

            const actionButton = document.getElementById(`btn-${type}`);
            document.querySelectorAll('.action-button').forEach(btn => btn.classList.add('loading'));
            updateStatus('Generating insights with Google AI...');
            textOutput.innerHTML = '<p>Contacting Gemini...</p>';
            showAIView();
            updateTitlesAndViews(type);

            const prompt = getAIPrompt(extractedText, type);

            try {
                const result = await aiModel.generateContent(prompt);
                const response = await result.response;
                const aiText = response.text();
                
                const formattedHtml = formatAIResponse(aiText);
                aiInsightsCache[type] = formattedHtml;
                textOutput.innerHTML = formattedHtml;

            } catch (error) {
                console.error("AI Error:", error);
                showError("Error communicating with the AI. Please check your API key and network connection. Details: " + error.message);
                textOutput.innerHTML = '<p>An error occurred. Please try again.</p>';
            } finally {
                document.querySelectorAll('.action-button').forEach(btn => btn.classList.remove('loading'));
                updateStatus('');
            }
        }

        function getAIPrompt(text, analysisType) {
            const basePrompt = `You are an expert Senior Technical Recruiter and career coach. Analyze the following resume text carefully. Provide clear, concise, and actionable insights. The resume text is:\n\n---\n${text}\n---\n\n`;

            switch (analysisType) {
                case 'redFlags':
                    return basePrompt + "Identify potential red flags or areas of concern for a hiring manager. These could include unexplained employment gaps, lack of quantifiable achievements, excessive jargon, typos, or passive language. Format the output as a bulleted list. If no major flags are found, state that the resume looks solid and mention its strengths.";
                case 'summary':
                    return basePrompt + "Write a concise, professional summary of this candidate (2-4 sentences). Highlight their key skills, years of experience, and primary qualifications. This summary should be suitable for a hiring manager's initial screening notes.";
                case 'questions':
                    return basePrompt + "Based on the skills and experience listed in this resume, generate a list of 5-7 insightful interview questions. Include a mix of behavioral, technical, and project-based questions. Tailor the questions directly to the candidate's background. Format the output as a numbered list.";
                case 'email':
                    return basePrompt + "Draft a personalized, professional outreach email to this candidate for a potential job opportunity. Use placeholders like [Job Role], [Your Company Name], and [Your Name]. Dynamically infer the candidate's name from the resume and reference one specific skill or project from their resume to make the email more engaging. The tone should be friendly and professional.";
                default:
                    return text;
            }
        }

        function formatAIResponse(text) {
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\n\s*[\*|-]\s/g, '</li><li>') // List items
                .replace(/(\d+)\.\s/g, '<br>$1. '); // Numbered list spacing
            
            // Wrap lists in <ul>
            if (html.includes('<li>')) {
                html = '<ul><li>' + html.substring(html.indexOf('<li>') + 4) + '</li></ul>';
            }
            return html.replace(/\n/g, '<br>');
        }
        
        function updateTitlesAndViews(type) {
            const titles = {
                redFlags: 'Issues & Red Flags',
                summary: 'Candidate Summary',
                questions: 'Interview Questions',
                email: 'Outreach Email Draft'
            };
            resultsTitle.textContent = titles[type] || 'AI Insights';
        }

        function showAIView() {
            currentView = 'ai';
            textOutput.classList.add('ai-insights');
            aiViewBtn.classList.add('active');
            textViewBtn.classList.remove('active');
            const latestInsight = Object.values(aiInsightsCache).pop();
            if (latestInsight) {
                 textOutput.innerHTML = latestInsight;
            } else if (!document.querySelector('.action-button.loading')) {
                 runAIAnalysis('summary');
            }
        }
        
        function showTextView() {
            currentView = 'text';
            resultsTitle.textContent = 'Extracted Raw Text';
            textOutput.classList.remove('ai-insights');
            textOutput.textContent = extractedText;
            textViewBtn.classList.add('active');
            aiViewBtn.classList.remove('active');
        }
        
        async function copyText() {
            let textToCopy = currentView === 'ai' ? textOutput.innerText : extractedText;
            try {
                await navigator.clipboard.writeText(textToCopy);
                showToast('Content copied to clipboard!');
            } catch (err) {
                showError('Failed to copy text');
            }
        }
        
        function resetUpload() {
            extractedText = '';
            aiInsightsCache = {};
            resultsContainer.style.display = 'none';
            uploadArea.style.display = 'block';
        }
        
        // --- UI Helpers ---
        function showProgress() { uploadArea.style.display = 'none'; progressContainer.style.display = 'block'; resultsContainer.style.display = 'none'; }
        function hideProgress() { progressContainer.style.display = 'none'; }
        function updateProgress(percent, message) { progressFill.style.width = percent + '%'; progressFill.textContent = Math.round(percent) + '%'; if (message) statusMessage.textContent = message; }
        function updateStatus(message) { statusMessage.textContent = message; }
        function showError(message) { errorMessage.textContent = message; errorMessage.style.display = 'block'; }
        function hideError() { errorMessage.style.display = 'none'; }
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; bottom: 20px; right: 20px; background: var(--dark-color); color: white; padding: 15px 20px; border-radius: 8px; z-index: 1000; transition: opacity 0.3s;`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => document.body.removeChild(toast), 300); }, 3000);
        }
    </script>
</body>
</html>
