<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruiter's AI Assistant - Structured JSON Output</title>
    
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Google AI SDK -->
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    
    <style>
        :root {
            --primary-color: #4a69bd;
            --secondary-color: #1abc9c;
            --dark-color: #2c3e50;
            --light-bg: #f8f9ff;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #2ecc71;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px; width: 100%; padding: 40px;
        }
        
        h1 { color: var(--dark-color); margin-bottom: 10px; font-size: 2em; text-align: center; }
        .subtitle { text-align: center; color: #555; margin-bottom: 30px; }
        
        .api-key-container { background: var(--light-bg); padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
        .api-key-container input { width: 100%; max-width: 400px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-right: 10px; }
        .api-key-container button { padding: 12px 20px; font-weight: 600; }

        .upload-area { border: 3px dashed var(--secondary-color); border-radius: 15px; padding: 40px; text-align: center; background: #f8f9ff; transition: all 0.3s ease; cursor: pointer; margin-bottom: 30px; }
        .upload-area:hover { border-color: var(--primary-color); background: #f0f2ff; }
        .upload-icon { font-size: 48px; color: var(--secondary-color); margin-bottom: 15px; }
        input[type="file"] { display: none; }
        
        .progress-container { display: none; margin-bottom: 30px; }
        .progress-bar { width: 100%; height: 30px; background: #f0f0f0; border-radius: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--secondary-color), var(--primary-color)); border-radius: 15px; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .status-message { text-align: center; margin-top: 10px; color: #666; font-size: 14px; }
        
        .results-container { display: none; }
        .main-layout { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .ai-actions-panel { background: var(--light-bg); border-radius: 15px; padding: 20px; }
        .ai-actions-title { font-size: 1.2em; color: var(--dark-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .action-button { display: block; width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 8px; background: #fff; color: #333; font-size: 15px; font-weight: 600; text-align: left; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .action-button:hover, .action-button.loading { background: var(--secondary-color); color: white; transform: translateX(5px); }
        .action-button.loading { cursor: not-allowed; animation: pulse 1.5s infinite; }

        .output-panel { min-height: 400px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .results-title { font-size: 1.5em; color: #333; }
        
        .btn { padding: 8px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(74, 105, 189, 0.4); }
        .btn-secondary { background: #f0f0f0; color: #666; }
        .btn-secondary.active { background: var(--dark-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        
        .text-output { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px; padding: 20px; height: 500px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 15px; line-height: 1.7; }
        .json-renderer h3 { color: var(--dark-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px; margin: 20px 0 10px 0; font-size: 1.2em; }
        .json-renderer p { margin-bottom: 10px; }
        .json-renderer .summary-block { background: #e9f7ef; padding: 15px; border-left: 4px solid var(--success-color); border-radius: 5px; margin-bottom: 15px; }
        .json-renderer ul { list-style: none; padding: 0; }
        .json-renderer li { display: flex; align-items: flex-start; margin-bottom: 8px; }
        .json-renderer li::before { content: '✓'; color: var(--success-color); font-weight: bold; margin-right: 10px; }
        .json-renderer .red-flags li::before { content: '⚠️'; color: var(--warning-color); }
        .json-renderer .email-template { background: #eaf2f8; padding: 15px; border-left: 4px solid var(--primary-color); border-radius: 8px; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; }
        .bottom-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        
        .info-box { background: #e7f3ff; border-left: 4px solid #3498db; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .info-box p { color: #555; font-size: 14px; margin: 5px 0; }
        .info-box a { color: var(--primary-color); font-weight: bold; }
        .error-message { background: #fee; color: #c00; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* Settings Panel Styles */
        .settings-icon { position: absolute; top: 20px; right: 20px; background: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 100; }
        .settings-icon:hover { transform: rotate(90deg); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .settings-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 998; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .settings-overlay.active { opacity: 1; visibility: visible; }
        .settings-panel { position: fixed; top: 0; right: -500px; width: 500px; max-width: 90vw; height: 100vh; background: white; box-shadow: -5px 0 25px rgba(0,0,0,0.3); z-index: 999; transition: right 0.3s ease; overflow-y: auto; display: flex; flex-direction: column; }
        .settings-panel.active { right: 0; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; padding: 25px; border-bottom: 2px solid #eee; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .settings-header h2 { margin: 0; font-size: 1.5em; }
        .settings-close { background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.3s; }
        .settings-close:hover { background: rgba(255,255,255,0.3); }
        .settings-tabs { display: flex; border-bottom: 2px solid #eee; background: #f8f9ff; }
        .settings-tab { flex: 1; padding: 15px 10px; border: none; background: transparent; cursor: pointer; font-size: 14px; font-weight: 600; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .settings-tab:hover { background: rgba(74, 105, 189, 0.1); }
        .settings-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: white; }
        .settings-content { flex: 1; overflow-y: auto; }
        .settings-tab-content { display: none; padding: 25px; }
        .settings-tab-content.active { display: block; }
        .settings-section { margin-bottom: 30px; }
        .settings-section h3 { color: var(--dark-color); margin-bottom: 15px; font-size: 1.1em; border-bottom: 2px solid var(--secondary-color); padding-bottom: 8px; }
        .settings-section label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; font-size: 14px; }
        .settings-section textarea { width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical; }
        .settings-section input[type="number"], .settings-section select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .settings-section input[type="range"] { width: 100%; }
        .helper-text { font-size: 12px; color: #888; margin-top: 5px; font-style: italic; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-item label { margin: 0; cursor: pointer; font-weight: 500; }
        .quick-toggles { display: flex; gap: 10px; margin-bottom: 15px; }
        .quick-toggle-btn { padding: 8px 15px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s; }
        .quick-toggle-btn:hover { background: var(--light-bg); }
        .reset-individual-btn { padding: 6px 12px; background: #f39c12; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; margin-top: 8px; transition: all 0.3s; }
        .reset-individual-btn:hover { background: #e67e22; }
        .slider-container { margin-bottom: 20px; }
        .slider-value { display: inline-block; margin-left: 10px; font-weight: 600; color: var(--primary-color); }
        .settings-actions { padding: 20px 25px; border-top: 2px solid #eee; background: #f8f9ff; display: flex; gap: 10px; flex-wrap: wrap; }
        .settings-save-btn { flex: 1; padding: 12px 20px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .settings-save-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(74, 105, 189, 0.4); }
        .reset-all-btn { flex: 1; padding: 12px 20px; background: var(--danger-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .reset-all-btn:hover { background: #c0392b; transform: translateY(-2px); }
        @keyframes slideIn { from { right: -500px; } to { right: 0; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <button class="settings-icon" onclick="openSettings()" title="Settings">⚙️</button>
        <h1>🤖 Recruiter's AI Assistant</h1>
        <p class="subtitle">Structured resume analysis with Google's Gemini AI</p>

        <div id="apiKeyContainer" class="api-key-container">
            <h3>Enter Your Google AI API Key</h3>
            <p style="font-size: 14px; color: #666; margin: 10px 0;">Your key is stored only in your browser and is never shared.</p>
            <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API Key">
            <button class="btn btn-primary" id="saveApiKeyBtn">Save Key</button>
            <p style="font-size: 12px; margin-top: 15px;"><a href="https://aistudio.google.com/app/apikey" target="_blank">Get your API key from Google AI Studio</a></p>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="info-box">
                <p>🚀 <strong>AI Model:</strong> Using <strong id="currentModelDisplay">gemini-2.5-flash-lite</strong> with structured JSON output. <span style="color: #888; font-size: 12px;">(Change in Settings ⚙️)</span></p>
            </div>
            
            <div class="upload-area" id="uploadArea"><div class="upload-icon">📄</div><div class="upload-text">Click to upload or drag & drop a resume (PDF)</div><input type="file" id="fileInput" accept=".pdf"></div>
            
            <div class="progress-container" id="progressContainer"><div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div><div class="status-message" id="statusMessage">Initializing...</div></div>
        </div>

        <div class="results-container" id="resultsContainer">
            <div class="main-layout">
                <div class="ai-actions-panel">
                    <h3 class="ai-actions-title">AI Analysis Actions</h3>
                    <button class="action-button" id="btn-redFlags" onclick="runAIAnalysis('redFlags')">🔍 Screen for Issues & Red Flags</button>
                    <button class="action-button" id="btn-summary" onclick="runAIAnalysis('summary')">📝 Generate Candidate Summary</button>
                    <button class="action-button" id="btn-questions" onclick="runAIAnalysis('questions')">❓ Generate Interview Questions</button>
                    <button class="action-button" id="btn-email" onclick="runAIAnalysis('email')">📧 Draft Outreach Email</button>
                </div>
                <div class="output-panel">
                    <div class="results-header">
                        <div class="results-title" id="resultsTitle">AI Insights</div>
                        <div><button class="btn btn-secondary active" id="aiViewBtn">AI Insights</button><button class="btn btn-secondary" id="textViewBtn">Raw Text</button></div>
                    </div>
                    <div class="text-output" id="textOutput"></div>
                     <div class="bottom-actions">
                        <button class="btn btn-secondary" onclick="copyText()">📋 Copy Insights</button>
                        <button class="btn btn-primary" onclick="resetUpload()">+ Upload New Resume</button>
                        <button class="btn btn-danger" id="resetApiKeyBtn">Reset API Key</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
    </div>
    
    <!-- Settings Panel -->
    <div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>⚙️ AI Settings</h2>
            <button class="settings-close" onclick="closeSettings()">×</button>
        </div>
        
        <div class="settings-tabs">
            <button class="settings-tab active" onclick="switchSettingsTab('prompts')">Prompts</button>
            <button class="settings-tab" onclick="switchSettingsTab('privacy')">Privacy & Actions</button>
            <button class="settings-tab" onclick="switchSettingsTab('parameters')">AI Parameters</button>
        </div>
        
        <div class="settings-content">
            <!-- Tab 1: Prompt Templates -->
            <div id="tab-prompts" class="settings-tab-content active">
                <div class="helper-text" style="margin-bottom: 20px; background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107;">
                    💡 Use <strong>{resume}</strong> placeholder in your prompts. It will be replaced with the filtered resume text based on your privacy settings.
                </div>
                
                <div class="settings-section">
                    <label>Red Flags Analysis Prompt</label>
                    <textarea id="prompt-redFlags"></textarea>
                    <button class="reset-individual-btn" onclick="resetIndividualPrompt('redFlags')">Reset to Default</button>
                </div>
                
                <div class="settings-section">
                    <label>Candidate Summary Prompt</label>
                    <textarea id="prompt-summary"></textarea>
                    <button class="reset-individual-btn" onclick="resetIndividualPrompt('summary')">Reset to Default</button>
                </div>
                
                <div class="settings-section">
                    <label>Interview Questions Prompt</label>
                    <textarea id="prompt-questions"></textarea>
                    <button class="reset-individual-btn" onclick="resetIndividualPrompt('questions')">Reset to Default</button>
                </div>
                
                <div class="settings-section">
                    <label>Outreach Email Prompt</label>
                    <textarea id="prompt-email"></textarea>
                    <button class="reset-individual-btn" onclick="resetIndividualPrompt('email')">Reset to Default</button>
                </div>
            </div>
            
            <!-- Tab 2: Privacy & Actions -->
            <div id="tab-privacy" class="settings-tab-content">
                <div class="settings-section">
                    <h3>Data Privacy Controls</h3>
                    <p class="helper-text">Control what information from resumes is shared with the AI</p>
                    <div class="quick-toggles">
                        <button class="quick-toggle-btn" onclick="toggleAllPrivacy(true)">Select All</button>
                        <button class="quick-toggle-btn" onclick="toggleAllPrivacy(false)">Select None</button>
                    </div>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="privacy-contact" checked>
                            <label for="privacy-contact">Include Contact Information (phone, email, address)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="privacy-personal" checked>
                            <label for="privacy-personal">Include Personal Details (name, photo references)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="privacy-work" checked>
                            <label for="privacy-work">Include Full Work History</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="privacy-education" checked>
                            <label for="privacy-education">Include Education Details</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="privacy-skills" checked>
                            <label for="privacy-skills">Include Skills & Certifications</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="privacy-projects" checked>
                            <label for="privacy-projects">Include Projects & Portfolio</label>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Visible Analysis Actions</h3>
                    <p class="helper-text">Choose which AI analysis buttons to show in the sidebar</p>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="action-redFlags" checked onchange="updateVisibleActions()">
                            <label for="action-redFlags">Show "Screen for Issues & Red Flags"</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="action-summary" checked onchange="updateVisibleActions()">
                            <label for="action-summary">Show "Generate Candidate Summary"</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="action-questions" checked onchange="updateVisibleActions()">
                            <label for="action-questions">Show "Generate Interview Questions"</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="action-email" checked onchange="updateVisibleActions()">
                            <label for="action-email">Show "Draft Outreach Email"</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab 3: AI Parameters -->
            <div id="tab-parameters" class="settings-tab-content">
                <div class="settings-section">
                    <label>AI Model</label>
                    <select id="param-model">
                        <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite (Recommended, Fastest)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Balanced)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Most Capable)</option>
                    </select>
                    <p class="helper-text">Choose the AI model for analysis. Flash models are faster, Pro is more thorough.</p>
                </div>
                
                <div class="settings-section">
                    <label>Temperature (Creativity)</label>
                    <div class="slider-container">
                        <input type="range" id="param-temperature" min="0" max="2" step="0.1" value="1.0" oninput="document.getElementById('temp-value').textContent = this.value">
                        <span class="slider-value" id="temp-value">1.0</span>
                    </div>
                    <p class="helper-text">Lower values (0.0-0.5) are more focused, higher values (1.5-2.0) are more creative.</p>
                </div>
                
                <div class="settings-section">
                    <label>Max Output Tokens</label>
                    <div class="slider-container">
                        <input type="range" id="param-maxTokens" min="512" max="8192" step="256" value="2048" oninput="document.getElementById('tokens-value').textContent = this.value">
                        <span class="slider-value" id="tokens-value">2048</span>
                    </div>
                    <p class="helper-text">Maximum length of AI responses. Higher values allow longer outputs.</p>
                </div>
            </div>
        </div>
        
        <div class="settings-actions">
            <button class="settings-save-btn" onclick="saveSettings()">💾 Save Settings</button>
            <button class="reset-all-btn" onclick="resetAllSettings()">🔄 Reset All to Defaults</button>
        </div>
    </div>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let extractedText = '';
        let aiInsightsCache = {};
        let currentView = 'ai';
        let genAI, aiModel;
        
        // Default Settings Configuration
        const DEFAULT_PROMPTS = {
            redFlags: `You are an expert Senior Technical Recruiter. Analyze the following resume text and return a response ONLY in the specified JSON format. Do not include any text outside of the JSON structure. Resume text is:
---
{resume}
---

Format your response as a JSON object with three keys: "analysis_summary" (a string with a brief overall assessment), "red_flags" (an array of strings detailing potential issues), and "strengths" (an array of strings highlighting positive aspects). If no flags are found, the "red_flags" array should be empty.`,
            summary: `You are an expert Senior Technical Recruiter. Analyze the following resume text and return a response ONLY in the specified JSON format. Do not include any text outside of the JSON structure. Resume text is:
---
{resume}
---

Format your response as a JSON object with three keys: "candidate_name" (a string for the candidate's full name, or "Not Found"), "professional_summary" (a 2-3 sentence string summarizing their profile), and "key_skills" (an array of strings of their most important skills).`,
            questions: `You are an expert Senior Technical Recruiter. Analyze the following resume text and return a response ONLY in the specified JSON format. Do not include any text outside of the JSON structure. Resume text is:
---
{resume}
---

Format your response as a JSON object with two keys: "behavioral_questions" (an array of strings for behavioral/situational questions) and "technical_questions" (an array of strings for technical questions based on their skills). Provide 3-4 questions for each category.`,
            email: `You are an expert Senior Technical Recruiter. Analyze the following resume text and return a response ONLY in the specified JSON format. Do not include any text outside of the JSON structure. Resume text is:
---
{resume}
---

Format your response as a JSON object with three keys: "recipient_name" (a string with the candidate's inferred name), "subject" (a string for a compelling subject line), and "body" (a string for the email content, using placeholders like [Job Role], [Your Company Name], and [Your Name]).`
        };
        
        const DEFAULT_SETTINGS = {
            prompts: { ...DEFAULT_PROMPTS },
            privacy: {
                includeContact: true,
                includePersonal: true,
                includeWorkHistory: true,
                includeEducation: true,
                includeSkills: true,
                includeProjects: true
            },
            params: {
                model: "gemini-2.5-flash-lite",
                temperature: 1.0,
                maxTokens: 2048
            },
            visibleActions: {
                redFlags: true,
                summary: true,
                questions: true,
                email: true
            }
        };
        
        let currentSettings = { ...DEFAULT_SETTINGS };

        const ui = {
            apiKeyContainer: document.getElementById('apiKeyContainer'),
            mainContent: document.getElementById('mainContent'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveApiKeyBtn: document.getElementById('saveApiKeyBtn'),
            resetApiKeyBtn: document.getElementById('resetApiKeyBtn'),
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            progressContainer: document.getElementById('progressContainer'),
            progressFill: document.getElementById('progressFill'),
            statusMessage: document.getElementById('statusMessage'),
            resultsContainer: document.getElementById('resultsContainer'),
            textOutput: document.getElementById('textOutput'),
            errorMessage: document.getElementById('errorMessage'),
            resultsTitle: document.getElementById('resultsTitle'),
            aiViewBtn: document.getElementById('aiViewBtn'),
            textViewBtn: document.getElementById('textViewBtn')
        };
        
        // Settings Management Functions
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('aiSettings');
                if (savedSettings) {
                    currentSettings = JSON.parse(savedSettings);
                    // Merge with defaults to ensure new settings are present
                    currentSettings = {
                        prompts: { ...DEFAULT_PROMPTS, ...currentSettings.prompts },
                        privacy: { ...DEFAULT_SETTINGS.privacy, ...currentSettings.privacy },
                        params: { ...DEFAULT_SETTINGS.params, ...currentSettings.params },
                        visibleActions: { ...DEFAULT_SETTINGS.visibleActions, ...currentSettings.visibleActions }
                    };
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                currentSettings = { ...DEFAULT_SETTINGS };
            }
            applySettingsToUI();
        }
        
        function applySettingsToUI() {
            // Apply prompts
            document.getElementById('prompt-redFlags').value = currentSettings.prompts.redFlags;
            document.getElementById('prompt-summary').value = currentSettings.prompts.summary;
            document.getElementById('prompt-questions').value = currentSettings.prompts.questions;
            document.getElementById('prompt-email').value = currentSettings.prompts.email;
            
            // Apply privacy settings
            document.getElementById('privacy-contact').checked = currentSettings.privacy.includeContact;
            document.getElementById('privacy-personal').checked = currentSettings.privacy.includePersonal;
            document.getElementById('privacy-work').checked = currentSettings.privacy.includeWorkHistory;
            document.getElementById('privacy-education').checked = currentSettings.privacy.includeEducation;
            document.getElementById('privacy-skills').checked = currentSettings.privacy.includeSkills;
            document.getElementById('privacy-projects').checked = currentSettings.privacy.includeProjects;
            
            // Apply visible actions
            document.getElementById('action-redFlags').checked = currentSettings.visibleActions.redFlags;
            document.getElementById('action-summary').checked = currentSettings.visibleActions.summary;
            document.getElementById('action-questions').checked = currentSettings.visibleActions.questions;
            document.getElementById('action-email').checked = currentSettings.visibleActions.email;
            
            // Apply AI parameters
            document.getElementById('param-model').value = currentSettings.params.model;
            document.getElementById('param-temperature').value = currentSettings.params.temperature;
            document.getElementById('temp-value').textContent = currentSettings.params.temperature;
            document.getElementById('param-maxTokens').value = currentSettings.params.maxTokens;
            document.getElementById('tokens-value').textContent = currentSettings.params.maxTokens;
            
            // Update visible actions
            updateVisibleActions();
            
            // Update model display
            const modelDisplay = document.getElementById('currentModelDisplay');
            if (modelDisplay) {
                modelDisplay.textContent = currentSettings.params.model;
            }
        }
        
        function saveSettings() {
            // Collect settings from UI
            currentSettings = {
                prompts: {
                    redFlags: document.getElementById('prompt-redFlags').value,
                    summary: document.getElementById('prompt-summary').value,
                    questions: document.getElementById('prompt-questions').value,
                    email: document.getElementById('prompt-email').value
                },
                privacy: {
                    includeContact: document.getElementById('privacy-contact').checked,
                    includePersonal: document.getElementById('privacy-personal').checked,
                    includeWorkHistory: document.getElementById('privacy-work').checked,
                    includeEducation: document.getElementById('privacy-education').checked,
                    includeSkills: document.getElementById('privacy-skills').checked,
                    includeProjects: document.getElementById('privacy-projects').checked
                },
                params: {
                    model: document.getElementById('param-model').value,
                    temperature: parseFloat(document.getElementById('param-temperature').value),
                    maxTokens: parseInt(document.getElementById('param-maxTokens').value)
                },
                visibleActions: {
                    redFlags: document.getElementById('action-redFlags').checked,
                    summary: document.getElementById('action-summary').checked,
                    questions: document.getElementById('action-questions').checked,
                    email: document.getElementById('action-email').checked
                }
            };
            
            // Save to localStorage
            localStorage.setItem('aiSettings', JSON.stringify(currentSettings));
            
            // Update AI model if needed
            if (genAI) {
                aiModel = genAI.getGenerativeModel({ model: currentSettings.params.model });
            }
            
            // Update visible actions
            updateVisibleActions();
            
            // Update model display
            const modelDisplay = document.getElementById('currentModelDisplay');
            if (modelDisplay) {
                modelDisplay.textContent = currentSettings.params.model;
            }
            
            // Clear cache to force re-analysis with new settings
            aiInsightsCache = {};
            
            showToast('✅ Settings saved successfully!');
            closeSettings();
        }
        
        function resetAllSettings() {
            if (confirm('Are you sure you want to reset all settings to default? This cannot be undone.')) {
                currentSettings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
                localStorage.setItem('aiSettings', JSON.stringify(currentSettings));
                applySettingsToUI();
                
                // Update AI model
                if (genAI) {
                    aiModel = genAI.getGenerativeModel({ model: currentSettings.params.model });
                }
                
                // Clear cache
                aiInsightsCache = {};
                
                showToast('✅ All settings reset to defaults!');
            }
        }
        
        function resetIndividualPrompt(type) {
            if (confirm(`Reset this prompt to default?`)) {
                document.getElementById(`prompt-${type}`).value = DEFAULT_PROMPTS[type];
                showToast('✅ Prompt reset to default!');
            }
        }
        
        function toggleAllPrivacy(value) {
            document.getElementById('privacy-contact').checked = value;
            document.getElementById('privacy-personal').checked = value;
            document.getElementById('privacy-work').checked = value;
            document.getElementById('privacy-education').checked = value;
            document.getElementById('privacy-skills').checked = value;
            document.getElementById('privacy-projects').checked = value;
        }
        
        function updateVisibleActions() {
            const actions = ['redFlags', 'summary', 'questions', 'email'];
            let visibleCount = 0;
            
            actions.forEach(action => {
                const checkbox = document.getElementById(`action-${action}`);
                const button = document.getElementById(`btn-${action}`);
                
                if (checkbox && button) {
                    if (checkbox.checked) {
                        button.style.display = 'block';
                        visibleCount++;
                    } else {
                        button.style.display = 'none';
                    }
                }
            });
            
            // Ensure at least one action is visible
            if (visibleCount === 0) {
                const firstCheckbox = document.getElementById('action-summary');
                firstCheckbox.checked = true;
                document.getElementById('btn-summary').style.display = 'block';
                showToast('⚠️ At least one action must be visible!');
            }
        }
        
        function openSettings() {
            document.getElementById('settingsOverlay').classList.add('active');
            document.getElementById('settingsPanel').classList.add('active');
        }
        
        function closeSettings() {
            document.getElementById('settingsOverlay').classList.remove('active');
            document.getElementById('settingsPanel').classList.remove('active');
        }
        
        function switchSettingsTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        function getFilteredResumeText(text) {
            let filtered = text;
            
            // Apply privacy filters
            if (!currentSettings.privacy.includeContact) {
                // Remove email addresses
                filtered = filtered.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g, '[CONTACT REMOVED]');
                // Remove phone numbers (various formats)
                filtered = filtered.replace(/(\+\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g, '[PHONE REMOVED]');
                // Remove potential addresses (basic pattern)
                filtered = filtered.replace(/\d+\s+[\w\s]+(?:street|st|avenue|ave|road|rd|highway|hwy|square|sq|trail|trl|drive|dr|court|ct|parkway|pkwy|circle|cir|boulevard|blvd)\b/gi, '[ADDRESS REMOVED]');
            }
            
            // Note: Other privacy filters can be enhanced based on specific patterns
            // For now, contact info is the most critical
            
            return filtered;
        }
        
        // Keyboard shortcut for settings
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                e.preventDefault();
                openSettings();
            }
            if (e.key === 'Escape') {
                closeSettings();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            const apiKey = localStorage.getItem('geminiApiKey');
            if (apiKey) initializeAI(apiKey);
            else { ui.apiKeyContainer.style.display = 'block'; ui.mainContent.style.display = 'none'; }
        });

        ui.saveApiKeyBtn.addEventListener('click', () => {
            const apiKey = ui.apiKeyInput.value.trim();
            if (apiKey) { localStorage.setItem('geminiApiKey', apiKey); initializeAI(apiKey); } 
            else { showError("Please enter a valid API key."); }
        });

        ui.resetApiKeyBtn.addEventListener('click', () => {
            if (confirm("Are you sure?")) { localStorage.removeItem('geminiApiKey'); location.reload(); }
        });

        function initializeAI(apiKey) {
            try {
                genAI = new window.GoogleGenerativeAI(apiKey);
                aiModel = genAI.getGenerativeModel({ model: currentSettings.params.model });
                ui.apiKeyContainer.style.display = 'none';
                ui.mainContent.style.display = 'block';
                hideError();
            } catch (error) {
                showError("Failed to initialize AI. The API key might be invalid.");
                localStorage.removeItem('geminiApiKey');
            }
        }

        ui.uploadArea.addEventListener('click', () => ui.fileInput.click());
        ui.fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        ui.aiViewBtn.addEventListener('click', showAIView);
        ui.textViewBtn.addEventListener('click', showTextView);
        
        async function handleFile(file) {
            if (file.type !== 'application/pdf') { showError('Please upload a valid PDF file'); return; }
            hideError(); showProgress();
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                extractedText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    updateProgress((i - 1) / pdf.numPages * 100, `Extracting text from page ${i}...`);
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    extractedText += textContent.items.map(item => item.str).join(' ');
                }
                displayResults();
            } catch (error) { showError('Error processing PDF: ' + error.message); hideProgress(); }
        }
        
        function displayResults() {
            hideProgress();
            ui.resultsContainer.style.display = 'block';
            aiInsightsCache = {};
            runAIAnalysis('summary');
        }

        async function runAIAnalysis(type) {
            if (!aiModel) { showError("AI not initialized. Check API Key."); return; }
            if (aiInsightsCache[type]) { renderJsonResponse(aiInsightsCache[type], type); return; }

            document.querySelectorAll('.action-button').forEach(btn => btn.classList.add('loading'));
            updateStatus('Generating structured insights with Google AI...');
            ui.textOutput.innerHTML = '<p>Contacting Gemini and awaiting structured JSON response...</p>';
            showAIView();
            updateTitles(type);

            const prompt = getAIPrompt(extractedText, type);

            try {
                const result = await aiModel.generateContent({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { 
                        responseMimeType: "application/json",
                        temperature: currentSettings.params.temperature,
                        maxOutputTokens: currentSettings.params.maxTokens
                    }
                });
                const responseText = result.response.text();
                const jsonResponse = JSON.parse(responseText);
                
                aiInsightsCache[type] = jsonResponse;
                renderJsonResponse(jsonResponse, type);

            } catch (error) {
                console.error("AI Error:", error);
                showError("Error generating or parsing AI response. The model may have failed to produce valid JSON. Details: " + error.message);
                ui.textOutput.innerHTML = `<p><strong>Error:</strong> The AI response could not be processed. Please try again.</p><pre>${error}</pre>`;
            } finally {
                document.querySelectorAll('.action-button').forEach(btn => btn.classList.remove('loading'));
                updateStatus('');
            }
        }

        function getAIPrompt(text, analysisType) {
            // Get filtered resume text based on privacy settings
            const filteredText = getFilteredResumeText(text);
            
            // Get custom prompt template or use default
            let promptTemplate = currentSettings.prompts[analysisType] || DEFAULT_PROMPTS[analysisType];
            
            // Replace {resume} placeholder with filtered resume text
            const finalPrompt = promptTemplate.replace(/{resume}/g, filteredText);
            
            return finalPrompt;
        }

        function renderJsonResponse(data, type) {
            let html = '<div class="json-renderer">';
            updateTitles(type);

            switch (type) {
                case 'redFlags':
                    html += `<div class="summary-block"><strong>Analysis Summary:</strong> ${data.analysis_summary || 'N/A'}</div>`;
                    if (data.strengths && data.strengths.length > 0) {
                        html += `<h3>Strengths</h3><ul>${data.strengths.map(s => `<li>${s}</li>`).join('')}</ul>`;
                    }
                    if (data.red_flags && data.red_flags.length > 0) {
                        html += `<h3 style="color:var(--warning-color);">Potential Red Flags</h3><ul class="red-flags">${data.red_flags.map(f => `<li>${f}</li>`).join('')}</ul>`;
                    } else {
                        html += `<h3>Potential Red Flags</h3><p>No significant red flags were detected.</p>`;
                    }
                    break;
                case 'summary':
                    html += `<h3>Candidate Summary</h3>`;
                    html += `<div class="summary-block"><strong>Name:</strong> ${data.candidate_name || 'N/A'}<br><strong>Summary:</strong> ${data.professional_summary || 'N/A'}</div>`;
                    if (data.key_skills && data.key_skills.length > 0) {
                        html += `<h3>Key Skills Identified</h3><ul>${data.key_skills.map(s => `<li>${s}</li>`).join('')}</ul>`;
                    }
                    break;
                case 'questions':
                    if (data.behavioral_questions && data.behavioral_questions.length > 0) {
                        html += `<h3>Behavioral Questions</h3><ul>${data.behavioral_questions.map(q => `<li>${q}</li>`).join('')}</ul>`;
                    }
                    if (data.technical_questions && data.technical_questions.length > 0) {
                        html += `<h3>Technical Questions</h3><ul>${data.technical_questions.map(q => `<li>${q}</li>`).join('')}</ul>`;
                    }
                    break;
                case 'email':
                    html += `<h3>Outreach Email Draft</h3>`;
                    html += `<div class="email-template"><strong>To:</strong> ${data.recipient_name || 'Candidate'}<br><strong>Subject:</strong> ${data.subject || 'Opportunity at [Your Company Name]'}<br><br>${data.body || 'Email body not generated.'}</div>`;
                    break;
            }
            ui.textOutput.innerHTML = html + '</div>';
        }
        
        function updateTitles(type) {
            const titles = { redFlags: 'Issues & Red Flags', summary: 'Candidate Summary', questions: 'Interview Questions', email: 'Outreach Email Draft' };
            ui.resultsTitle.textContent = titles[type] || 'AI Insights';
        }

        function showAIView() {
            currentView = 'ai';
            ui.aiViewBtn.classList.add('active'); ui.textViewBtn.classList.remove('active');
            const latestInsight = Object.values(aiInsightsCache).pop();
            if (latestInsight) renderJsonResponse(latestInsight, Object.keys(aiInsightsCache).pop());
            else if (!document.querySelector('.action-button.loading')) runAIAnalysis('summary');
        }
        
        function showTextView() {
            currentView = 'text';
            ui.resultsTitle.textContent = 'Extracted Raw Text';
            ui.aiViewBtn.classList.remove('active'); ui.textViewBtn.classList.add('active');
            ui.textOutput.textContent = extractedText;
        }
        
        async function copyText() {
            let textToCopy = currentView === 'ai' ? ui.textOutput.innerText : extractedText;
            try { await navigator.clipboard.writeText(textToCopy); showToast('Content copied!'); } 
            catch (err) { showError('Failed to copy text'); }
        }
        
        function resetUpload() {
            extractedText = ''; aiInsightsCache = {};
            ui.resultsContainer.style.display = 'none'; ui.uploadArea.style.display = 'block';
        }
        
        function showProgress() { ui.uploadArea.style.display = 'none'; ui.progressContainer.style.display = 'block'; ui.resultsContainer.style.display = 'none'; }
        function hideProgress() { ui.progressContainer.style.display = 'none'; }
        function updateProgress(percent, message) { ui.progressFill.style.width = percent + '%'; ui.progressFill.textContent = Math.round(percent) + '%'; if (message) ui.statusMessage.textContent = message; }
        function updateStatus(message) { ui.statusMessage.textContent = message; }
        function showError(message) { ui.errorMessage.textContent = message; ui.errorMessage.style.display = 'block'; }
        function hideError() { ui.errorMessage.style.display = 'none'; }
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; bottom: 20px; right: 20px; background: var(--dark-color); color: white; padding: 15px 20px; border-radius: 8px; z-index: 1000; transition: opacity 0.3s;`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => document.body.removeChild(toast), 300); }, 3000);
        }
    </script>
</body>
</html>
